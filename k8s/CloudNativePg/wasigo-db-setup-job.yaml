apiVersion: batch/v1
kind: Job
metadata:
  name: wasigo-db-setup-migrator
  namespace: traefik
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup-migrator
          image: docker.io/library/postgres:15-alpine
          env:
            - name: PGHOST
              value: "wasigo-db-rw"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: wasigo-db-superuser
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: wasigo-db-superuser
                  key: password
            - name: MIGRATOR_USER
              value: "wasigo_migrator"
            - name: MIGRATOR_PASS
              valueFrom:
                secretKeyRef:
                  name: wasigo-app-secrets
                  key: DB_MIGRATION_PASSWORD
            - name: APP_USER
              value: "wasigo_app"
          
          command: ["/bin/sh", "-c"]
          args:
            - |
              # üõë ESTA L√çNEA ES LA CLAVE: Detiene el script si hay error
              set -e

              echo "Esperando a la base de datos..."
              until pg_isready; do sleep 2; done;

              echo "1. Creando Usuario Migrador..."
              psql -c "DO \$\$ BEGIN IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '$MIGRATOR_USER') THEN CREATE ROLE $MIGRATOR_USER LOGIN PASSWORD '$MIGRATOR_PASS'; END IF; END \$\$;"

              echo "2. Aplicando Permisos..."
              psql -c "GRANT CONNECT ON DATABASE wasigo TO $MIGRATOR_USER;"
              psql -c "GRANT USAGE ON SCHEMA public TO $MIGRATOR_USER;"
              # ... (resto de tus comandos grant) ...
              psql -c "GRANT CREATE ON SCHEMA public TO $MIGRATOR_USER;"
              
              psql -c "GRANT USAGE, CREATE ON SCHEMA auth TO $MIGRATOR_USER;"
              psql -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA auth TO $MIGRATOR_USER;"
              psql -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA auth TO $MIGRATOR_USER;"

              psql -c "GRANT USAGE, CREATE ON SCHEMA business TO $MIGRATOR_USER;"
              psql -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA business TO $MIGRATOR_USER;"
              psql -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA business TO $MIGRATOR_USER;"

              psql -c "GRANT USAGE, CREATE ON SCHEMA audit TO $MIGRATOR_USER;"
              psql -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA audit TO $MIGRATOR_USER;"
              psql -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA audit TO $MIGRATOR_USER;"

              echo "3. Configurando Default Privileges..."
              psql -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA auth GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO $APP_USER;"
              psql -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA auth GRANT USAGE, SELECT ON SEQUENCES TO $APP_USER;"

              psql -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA business GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO $APP_USER;"
              psql -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA business GRANT USAGE, SELECT ON SEQUENCES TO $APP_USER;"

              psql -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA audit GRANT SELECT, INSERT ON TABLES TO $APP_USER;"
              psql -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA audit GRANT USAGE, SELECT ON SEQUENCES TO $APP_USER;"

              echo "¬°Configuraci√≥n REALMENTE Exitosa! ‚úÖ"