apiVersion: batch/v1
kind: Job
metadata:
  name: wasigo-db-setup-migrator
  namespace: traefik
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup-migrator
          image: docker.io/library/postgres:15-alpine
          env:
            - name: PGHOST
              value: "wasigo-db-rw"
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: wasigo-db-superuser
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: wasigo-db-superuser
                  key: password
            - name: MIGRATOR_USER
              value: "wasigo_migrator"
            - name: MIGRATOR_PASS
              valueFrom:
                secretKeyRef:
                  name: wasigo-app-secrets
                  key: DB_MIGRATION_PASSWORD
            - name: APP_USER
              value: "wasigo_app"
          
          command: ["/bin/sh", "-c"]
          args:
            - |
              # üõë 1. Modo estricto: Detener si algo falla
              set -e

              echo "Esperando a la base de datos..."
              until pg_isready; do sleep 2; done;

              echo "2. Creando Usuario Migrador..."
              # Este comando es global (sirve en cualquier DB), crea el usuario
              psql -c "DO \$\$ BEGIN IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '$MIGRATOR_USER') THEN CREATE ROLE $MIGRATOR_USER LOGIN PASSWORD '$MIGRATOR_PASS'; END IF; END \$\$;"

              echo "3. Aplicando Permisos (Conectando a 'wasigo')..."
              # Damos permiso para entrar
              psql -c "GRANT CONNECT ON DATABASE wasigo TO $MIGRATOR_USER;"

              # ‚ö†Ô∏è AQU√ç EST√Å EL CAMBIO CLAVE: '-d wasigo'
              # Sin esto, no encuentra los esquemas 'auth', 'business', etc.

              # --- Permisos Base ---
              psql -d wasigo -c "GRANT USAGE ON SCHEMA public TO $MIGRATOR_USER;"
              psql -d wasigo -c "GRANT CREATE ON SCHEMA public TO $MIGRATOR_USER;"
              
              # --- SCHEMA: AUTH ---
              psql -d wasigo -c "GRANT USAGE, CREATE ON SCHEMA auth TO $MIGRATOR_USER;"
              psql -d wasigo -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA auth TO $MIGRATOR_USER;"
              psql -d wasigo -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA auth TO $MIGRATOR_USER;"

              # --- SCHEMA: BUSINESS ---
              psql -d wasigo -c "GRANT USAGE, CREATE ON SCHEMA business TO $MIGRATOR_USER;"
              psql -d wasigo -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA business TO $MIGRATOR_USER;"
              psql -d wasigo -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA business TO $MIGRATOR_USER;"

              # --- SCHEMA: AUDIT ---
              psql -d wasigo -c "GRANT USAGE, CREATE ON SCHEMA audit TO $MIGRATOR_USER;"
              psql -d wasigo -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA audit TO $MIGRATOR_USER;"
              psql -d wasigo -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA audit TO $MIGRATOR_USER;"

              echo "4. Configurando Default Privileges..."
              # Tambi√©n aqu√≠ necesitamos '-d wasigo' para que aplique en la DB correcta
              
              psql -d wasigo -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA auth GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO $APP_USER;"
              psql -d wasigo -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA auth GRANT USAGE, SELECT ON SEQUENCES TO $APP_USER;"

              psql -d wasigo -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA business GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO $APP_USER;"
              psql -d wasigo -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA business GRANT USAGE, SELECT ON SEQUENCES TO $APP_USER;"

              psql -d wasigo -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA audit GRANT SELECT, INSERT ON TABLES TO $APP_USER;"
              psql -d wasigo -c "ALTER DEFAULT PRIVILEGES FOR ROLE $MIGRATOR_USER IN SCHEMA audit GRANT USAGE, SELECT ON SEQUENCES TO $APP_USER;"

              echo "‚úÖ ¬°Misi√≥n Cumplida! Usuario creado, permisos asignados y herencia configurada."